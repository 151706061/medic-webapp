<html>
	<head>
		<script src="js/medic-enketo-offline-SNAPSHOT.min.js"
				type="text/javascript"></script>
		<link type="text/css" rel="stylesheet" href="style/formhub.css"/>
		<style>
			#control-panel {
				margin-top:20px;
				padding-top:10px;
				border-top:solid 1px gray;
			}
			#control-panel > tbody > tr > td {
				padding:10px;
				border: solid 1px #ccc;
			}
		</style>
	</head>
	<body>
		<div id="form-wrapper" style="display:none">
			<div class="container"></div>
			<div class="form-footer" style="margin:0">
				<input type="submit" value="Validate" class="btn btn-primary"/>
				<br/>
				<br/>
				<button class="btn btn-primary first-page">&lt;&lt; Go to start</button>
				<button class="btn btn-primary previous-page">&lt; prev</button>
				<button class="btn btn-primary next-page">next &gt;</button>
				<button class="btn btn-primary last-page">Go to end &gt;&gt;</button>
			</div>
		</div>

		<table id="control-panel"><tbody>
			<tr><td>
				<h2>Instructions</h2>
				<p>Select a form from the list of available forms.  When you click the `load` button, it should be loaded
				from an XForms XML file, and then converted into both an HTML form and an XML validator using XSLT.</p>
				<p>If you would like to see the XForms XML that the form is generated from, click the `view` button.</p>
			</td></tr>
			<tr><td>
				<h2>Available forms</h2>
				<table id="form-examples">
					<tr><tr><td>Form ID</td></tr><td>View original form XML</td><td>Load form and display above</td></tr>
				</table>
			</td></tr>

			<td id="log">
				<h2>Log</h2>
				<div class="content">
				</div>
			</td></tr>
		</tbody></table>

		<script>
			window.medic_config = {
			  app_root: window.location.protocol + '//' + window.location.host,
			};

			require.config( {
			    shim: {
			        "widget/date/bootstrap3-datepicker/js/bootstrap-datepicker": {
			            deps: [ "jquery" ],
			            exports: "jQuery.fn.datepicker"
			        },
			        "widget/time/bootstrap3-timepicker/js/bootstrap-timepicker": {
			            deps: [ "jquery" ],
			            exports: "jQuery.fn.timepicker"
			        },
			        "leaflet": {
			            exports: "L"
			        }
			    }
			} );


			requirejs(['jquery'], function($) {
			  function log(message) {
			    console.log('LOG | ' + message);
			    $('#log .content').append('<pre>' + message + '</p>');
			    while($('#log .content').children().length > 5) {
			        $('#log .content pre:first').remove();
			    }
			  };
			  log('Scripts loaded.');

			  log('Requiring enketo form...');
			  requirejs(['enketo-js/Form'], function(Form) {
			    log('Enketo loaded.');

			    var showForm = function(formName, formHtml, formData) {
			      var form, formContainer, formWrapper,
			          init = function() {
			            var loadErrors;
			            form = new Form('#form-wrapper form', { modelStr:formData });
			            loadErrors = form.init();
			            if(loadErrors) log('loadErrors = ' + loadErrors);
			          },
			          xformDataAsJsonString = function(xml) {
			            var i, n,
			                data = xml.firstChild.childNodes,
			                json = {
			                  _meta:{
			                    form: formName,
			                    from: 'user:TODO',
			                    reported_date: Date.now()
			                  },
			                  fields: {}, // FIXME
			                };
			            for(i=0; i<data.length; ++i) {
			              n = data[i];
			              if(n.nodeType !== Node.ELEMENT_NODE ||
			                  n.nodeName === 'meta') continue;
			              json[n.nodeName] = n.textContent;
			              // FIXME as things generally aren't working,
			              // it's not clear if data should be included
			              // via `.fields` or in the root of the JSON.
			              // When that is clarified, one or other
			              // should be removed.
			              json.fields[n.nodeName] = n.textContent;
			            };
			            return JSON.stringify(json);
			          };

			      log('Adding form to DOM...');
			      formWrapper = $('#form-wrapper');
			      formWrapper.show();
			      formContainer = formWrapper.find('.container');
			      formContainer.empty();

			      formContainer.append(formHtml);

			      log('Attempting to load form with data of type: ' + (typeof formData));
			      formData = formData;
			      console.log('form:\n' + formData);
			      init();

			      $('#form-wrapper input[type=submit]').on('click', function() {
			        form.validate();
			        if(form.isValid()) {
			          log('Form content is valid!  Saving and resetting.');
			          var record = $.parseXML(form.getDataStr()),
			              addUrl = medic_config.app_root + '/api/v1/records',
			              validateButton = $('#form-wrapper input[type=submit]');
			          validateButton.prop('disabled', true);
			          record = xformDataAsJsonString(record);
			          $.ajax({
			            url: addUrl,
			            type: 'POST',
			            data: record,
			            headers: {
			              'Content-Type': 'application/json'
			            },
			            success: function() {
			              form.resetView();
			              init();
			            },
			            error: function(req, status, err) {
			              log('Error submitting form data: ' + {
			                req:req, status:status, error:err });
			            },
			            complete: function() {
			              validateButton.prop('disabled', false);
			            }
			          });
			        } else {
			          log('Form contains errors.  Please correct them.');
			        }
			      });

			      // Hide loading buttons (loading multiple forms without page reloads leads
			      // to some bugs.  Simpler to avoid these for now.
			      $('.btn.form-loader').replaceWith('(reload page to load a different form)');
			    };

			    var processors = {
			      html: { processor:new XSLTProcessor() },
			      model: { processor:new XSLTProcessor() } };
			    $.get('forms/openrosa2html5form.xsl').done(function(doc) {
			      processors.html.processor.importStylesheet(doc);
			      processors.html.loaded = true;
			    });
			    $.get('forms/openrosa2xmlmodel.xsl').done(function(doc) {
			      processors.model.processor.importStylesheet(doc);
			      processors.model.loaded = true;
			    });

			    var loadForm = function(name, url) {
			      if(!processors.html.loaded || !processors.model.loaded) {
			        return log('Not all processors are loaded yet.');
			      }

			      log('Loading form: ' + url + '...');
			      $.ajax(url).done(function(data) {
			        log('Loaded form.');
			        var doc = data,
			            html = processors.html.processor.transformToDocument(doc),
			            model = processors.model.processor.transformToDocument(doc);

			        console.log('XML');
			        console.log('---');
			        console.log(new XMLSerializer().serializeToString(model));

			        console.log('XML');
			        console.log('---');
			        console.log(new XMLSerializer().serializeToString(html));

			        showForm(name,
			            html.documentElement.innerHTML,
			            model.documentElement.innerHTML);
			      });
			    };

			    (function() {
			      var i, table = $('#form-examples'),
			          addFormToTable = function(id, name, url) {
			          table.append('<tr><td>' + name + '</td>' +
			              '<td><a href="' + url + '">view</a></td>' +
			              '<td><button class="btn btn-primary form-loader" onclick="loadXmlFrom(\'' + id + '\', \'' + url + '\')">load<button></td>' +
			              '</tr>');
			          };

			      window.loadXmlFrom = function(name, url) {
			        console.log('Should load from ' + url);
			        loadForm(name, url);
			      };

			      for(i=1; i<=2; ++i) {
			        addFormToTable('demo:' + i,
			           'Demo Form ' + i,
			           'forms/' + i + '.xml');
			      }

			      log('Fetching forms...');
			      $.ajax({
			        url: medic_config.app_root + '/api/v1/forms',
			        headers: { 'X-OpenRosa-Version':'1.0' },
			        success: function(xml) {
			          var i, xform,
			              xforms = xml.getElementsByTagName('xform');
			          log('Loaded ' + xforms.length + ' forms from DB.');
			          for(i=0; i<xforms.length; ++i) {
			            xform = xforms[i];
			            addFormToTable(xform.getElementsByTagName('formID')[0].textContent,
			                xform.getElementsByTagName('name')[0].textContent,
			                xform.getElementsByTagName('downloadUrl')[0].textContent);
			          }
			        }
			      });
			    }());
			  });
			});
		</script>
	</body>
</html>
